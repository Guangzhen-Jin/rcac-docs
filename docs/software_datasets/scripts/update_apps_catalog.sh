#!/usr/bin/env bash
# set -euo pipefail

MD_DIR="../software/apps_md"
INV_FILE="./rcac_apps_inventory.json"
DESC_FILE="./apps_descriptions.json" 
CATALOG_FILE="../software/app_catalog.md"
INDEX_FILE="../software/index.md"

mkdir -p "$(dirname "$CATALOG_FILE")"
mkdir -p "$(dirname "$INDEX_FILE")"

# Stats
today=$(date +"%B %d, %Y")
app_count=$(find "$MD_DIR" -type f -name "*.md" | wc -l)

version_count=$(find ../modulefiles -type f -name "*.lua" \
  ! -name ".*" \
  ! -name "*.modulerc.lua" \
  ! -regex '.*-[a-zA-Z0-9]\{7\}\.lua$' \
  ! -path "*/modtree/*" \
  ! -path "*/biocontainers/*" \
  ! -path "*/ngc/*" \
  ! -path "*/rocmcontainers/*" \
  | wc -l)

cluster_count=$(jq '[to_entries[] | .value.availability | keys[]] | unique | length' "$INV_FILE")
cluster_names=$(jq -r '[to_entries[] | .value.availability | keys[] | ascii_upcase] | unique | sort | join(", ")' "$INV_FILE")

{
  echo "---"
  echo "hide:"
  echo "  - footer"
  echo "  - toc"
  echo "---"
  echo
  echo "<!-- Note: this catalog file is generated by ../scripts/update_apps_catalog.sh. Manual changes will be lost!-->"
  echo
  echo "# All software and versions on RCAC clusters"
  echo
  echo "## Overview"
  echo "As of **$today**, there have been a total of **$app_count** applications with **$version_count** available versions deployed across **$cluster_count** RCAC HPC clusters: **$cluster_names**."
  echo
  echo "## Applications Catalog"
  echo
  echo '<table id="appTable" class="tablefilter">'
  echo "  <thead>"
  echo "    <tr><th><strong>Application</strong></th><th><strong>Topic</strong></th><th><strong>Available at</strong></th></tr>"
  echo "  </thead>"
  echo "  <tbody>"

  # Iterate through apps
  find "$MD_DIR" -type f -name "*.md" | sort | while read -r filepath; do
    app=$(basename "$filepath" .md)

    # Query cluster availability for the app (uppercase + comma separated)
    clusters=$(jq -r --arg app "$app" \
      '.[$app].availability | keys[]? | ascii_upcase' "$INV_FILE" 2>/dev/null \
      | sort -u | paste -sd "," - | sed 's/,/, /g')
    clusters=${clusters:-""}

    # Query topics from apps_descriptions.json (comma separated). fall back to empty.
    topics=$(jq -r --arg app "$app" '.[$app].topic // [] | join(", ")' "$DESC_FILE" 2>/dev/null || echo "")
    topics=${topics:-""}

    echo "    <tr>"
    echo "      <td><a href=\"../apps_md/$app\"><strong>$app</strong></a></td>"
    echo "      <td>$topics</td>"
    echo "      <td>$clusters</td>"
    echo "    </tr>"
  done

  echo "  </tbody>"
  echo "</table>"
  
} > "$CATALOG_FILE"

{
  echo "---"
  echo "hide:"
  echo "  - footer"
  echo "  - toc"
  echo "---"
  echo
  echo "<!-- Note: this index.md is generated by ../scripts/update_apps_catalog.sh. Manual changes will be lost!-->"
  echo
  echo "# Software and versions on RCAC clusters"
  echo
  echo "## Overview"
  echo "As of **$today**, there have been a total of **$app_count** applications with **$version_count** available versions deployed across **$cluster_count** RCAC HPC clusters: **$cluster_names**."
  echo
  echo "You can see [**a full list of all software and version deployed on all RCAC clusters**](app_catalog.md), OR"
  echo 
  echo "Check the most popular software in different domains below:"
  echo
  echo '<div class="grid cards" markdown>'
  echo
  echo "-   :material-application:{ .lg .middle } __Computational Chemistry__"
  echo
  echo "    ---"
  echo
  echo "    Chemistry software catalog of deployed applications on RCAC clusters."
  echo
  echo '    [:octicons-arrow-right-24: Computational Chemistry Software Catalog](chemistry_catalog.md)'
  echo
  echo "-   :material-application:{ .lg .middle } __Fluid Dynamics__"
  echo
  echo "    ---"
  echo 
  echo "    Fluid Dynamics software catalog of deployed applications on RCAC clusters."
  echo
  echo '    [:octicons-arrow-right-24: Fluid Dynamics Software Catalog](fluid_catalog.md)'
  echo
  echo "-   :material-application:{ .lg .middle } __MPIs__"
  echo
  echo "    ---"
  echo
  echo "    MPI software catalog of deployed applications on RCAC clusters."
  echo 
  echo '    [:octicons-arrow-right-24: MPIs Catalog](mpi_catalog.md)'
  echo
  echo "-   :material-application:{ .lg .middle } __Audio/Visualization__"
  echo
  echo "    ---"
  echo
  echo "    Audio/Visualization software catalog of deployed applications on RCAC clusters."
  echo 
  echo '    [:octicons-arrow-right-24: Audio/Visualization Software Catalog](audio_vis_catalog.md)'
  echo
  echo "-   :simple-docker:{ .lg .middle } __Biocontainers__"
  echo
  echo "    ---"
  echo
  echo "    Check the catalog of all deployed biocontainers on RCAC clusters."
  echo
  echo '    [:octicons-arrow-right-24: Biocontainers :octicons-link-external-16:](https://biocontainer-doc.readthedocs.io/en/latest/)'
  echo
  echo '</div>'

} > "$INDEX_FILE"

echo "Catalog updated at $CATALOG_FILE and $INDEX_FILE."
